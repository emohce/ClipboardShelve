# uTools 插件测试指南

## 📋 测试前准备

### 1. 环境要求
- ✅ 已安装 **uTools** 应用
- ✅ 已安装 **Node.js** 和包管理器（**npm** 或 **pnpm**）
- ✅ 项目依赖已安装

### 关于包管理器

**pnpm** 是一个快速的、节省磁盘空间的包管理器，但项目**完全兼容 npm**。

- **使用 npm**（推荐，如果你已有 npm）：
  ```bash
  npm install        # 安装依赖
  npm run serve      # 启动开发服务器
  npm run build      # 构建生产版本
  ```

- **使用 pnpm**（可选，更快更省空间）：
  ```bash
  # 如果没有 pnpm，先安装：npm install -g pnpm
  pnpm install       # 安装依赖
  pnpm run serve     # 启动开发服务器
  pnpm run build     # 构建生产版本
  ```

**注意**：如果使用 npm，首次安装后会自动生成 `package-lock.json`，这是正常的。

---

## 🚀 开发模式测试（推荐）

### 步骤 1: 安装依赖（如果还没安装）

```bash
# 使用 npm（推荐）
npm install

# 或使用 pnpm
pnpm install
```

### 步骤 2: 启动开发服务器

```bash
# 在项目根目录执行（使用 npm）
npm run serve

# 或者使用 pnpm（如果已安装）
pnpm run serve
```

开发服务器会在 `http://localhost:8081/` 启动，支持热重载。

### 步骤 3: 在 uTools 中加载插件

1. **打开 uTools**
2. **进入开发者模式**：
   - 按 `Alt + Space` 打开 uTools 主窗口
   - 点击右上角 **设置**（⚙️）
   - 找到 **开发者** 或 **开发模式** 选项并启用

3. **加载本地插件**：
   - 在 uTools 主窗口，按 `Ctrl + Shift + P`（或右键菜单选择"开发者工具"）
   - 选择 **"加载本地插件"** 或 **"导入插件"**
   - 选择项目根目录下的 `public` 文件夹
   - 或者直接选择项目根目录（uTools 会自动查找 `plugin.json`）

4. **验证插件加载**：
   - 插件列表中应该出现 **"超级剪贴板"**
   - 状态显示为 **"开发中"** 或 **"已加载"**

### 步骤 4: 启动插件

在 uTools 中：
- 输入命令：`剪切板`、`剪贴板` 或 `Clipboard`
- 或者从插件列表中找到 **"超级剪贴板"** 并点击

插件窗口应该会打开，并连接到 `http://localhost:8081/`

---

## 📦 生产模式测试

### 步骤 1: 构建项目

```bash
# 使用 npm
npm run build

# 或使用 pnpm
pnpm run build
```

构建完成后，会在 `dist` 目录生成生产文件。

### 步骤 2: 打包插件

1. **准备插件文件**：
   - 将 `dist` 目录中的文件复制到 `public` 目录
   - 确保 `public/plugin.json` 存在
   - 确保 `public/preload.js` 存在
   - 确保 `public/logo.png` 存在

2. **打包为 .upx 文件**（可选）：
   - 在 uTools 中，选择插件 → **"打包插件"**
   - 生成 `.upx` 文件用于分发

### 步骤 3: 测试生产版本

1. **加载插件**：
   - 在 uTools 开发者模式中，选择 **"导入插件"**
   - 选择包含 `plugin.json` 的目录（通常是 `public` 目录）

2. **启动插件**：
   - 输入命令启动插件
   - 此时插件使用本地文件，不依赖开发服务器

---

## 🧪 功能测试清单

### 基础功能测试

- [ ] **剪贴板监听**
  - 复制文本 → 检查是否出现在历史记录中
  - 复制图片 → 检查是否出现在历史记录中
  - 复制文件 → 检查是否出现在历史记录中

- [ ] **历史记录显示**
  - 检查所有 Tab（全部/文本/图片/文件/收藏）是否正常切换
  - 检查时间显示是否正确
  - 检查内容预览是否正常

### 新增功能测试（根据 toConfirm.md）

#### ✅ 任务 1: 收藏记录保护
- [ ] 多选模式下，选择包含已收藏的记录
- [ ] 点击删除按钮
- [ ] 验证：已收藏记录被跳过，只删除未收藏的记录

#### ✅ 任务 2: 删除确认弹窗
- [ ] 点击单个记录的删除按钮
- [ ] 验证：弹出确认对话框
- [ ] 验证：默认聚焦在"确定"按钮（可用 Tab 键切换）
- [ ] 验证：按 Enter 键可以确认删除

#### ✅ 任务 2.1: 收藏列表删除
- [ ] 切换到"收藏" Tab
- [ ] 点击删除按钮
- [ ] 验证：提示"确认取消收藏此记录？"
- [ ] 确认后：记录从收藏列表移除，但仍在历史记录中

#### ✅ 任务 3: 保留标记功能
- [ ] 右键点击记录 → 选择"保留"（📌）
- [ ] 验证：记录显示保留标记图标
- [ ] 验证：设置中"保留标记开关"已开启
- [ ] 验证：设置中"保留时长"可配置（1-72小时）
- [ ] 等待超过保留时长后重启插件
- [ ] 验证：保留标记自动过期移除

#### ✅ 任务 3.1: 快速删除（Ctrl+Shift+Del）
- [ ] 按 `Ctrl + Shift + Delete`
- [ ] 验证：弹出快速删除对话框
- [ ] 选择时间范围（1/3/6/12/24/28/48/72小时）
- [ ] 确认删除
- [ ] 验证：只删除指定时间范围内的记录
- [ ] 验证：已收藏和已保留的记录被跳过

#### ✅ 任务 4: 搜索排序优化
- [ ] 在搜索框中输入关键词
- [ ] 按 `Ctrl + Enter`
- [ ] 验证：提示"收藏优先显示"或"按时间排序"
- [ ] 验证：搜索结果中收藏的记录排在前面
- [ ] 验证：搜索框右侧显示 ⭐ 图标（收藏优先模式）

#### ✅ 任务 5: 多选操作优化
- [ ] 进入多选模式（点击 👆 或按 Shift）
- [ ] 按 `Shift + ↑` 或 `Shift + ↓`
- [ ] 验证：快速选中相邻的记录
- [ ] 选中多条记录后，按 `Delete` 键
- [ ] 验证：弹出批量删除确认对话框
- [ ] 选中多条记录后，按 `Ctrl + Enter`
- [ ] 验证：批量切换保留标记（如果部分已保留则全部取消，否则全部添加）

#### ✅ 任务 6: Tab 页快捷键
- [ ] 按 `Alt + Tab`
- [ ] 验证：切换到下一个 Tab
- [ ] 按 `Alt + 1`、`Alt + 2` 等
- [ ] 验证：快速定位到对应 Tab
- [ ] 按 `Alt + 0`
- [ ] 验证：切换到最后一个 Tab（收藏）

### 键盘快捷键测试

| 快捷键 | 功能 | 测试结果 |
|--------|------|----------|
| `Tab` | 循环切换 Tab | [ ] |
| `Alt + Tab` | 循环切换 Tab | [ ] |
| `Alt + 1~9` | 快速定位 Tab | [ ] |
| `Alt + 0` | 切换到收藏 Tab | [ ] |
| `Ctrl + F` / `Ctrl + L` | 聚焦搜索框 | [ ] |
| `Ctrl + Enter` | 搜索时：切换收藏优先 | [ ] |
| `Ctrl + Enter` | 多选时：批量切换保留标记 | [ ] |
| `Shift + ↑/↓` | 快速多选 | [ ] |
| `Delete` | 多选时：批量删除 | [ ] |
| `Ctrl + Shift + Delete` | 快速删除最近时间段 | [ ] |
| `Enter` | 删除确认弹窗中：确认删除 | [ ] |
| `Escape` | 退出多选/清空搜索 | [ ] |
| `↑/↓` | 导航记录 | [ ] |
| `Enter` | 复制并粘贴选中记录 | [ ] |
| `Space` | 多选模式下切换选中 | [ ] |

---

## 🐛 调试技巧

### 1. 打开开发者工具

在 uTools 插件窗口中：
- 按 `F12` 或 `Ctrl + Shift + I`（Windows/Linux）
- 或 `Cmd + Option + I`（macOS）

### 2. 查看控制台日志

```javascript
// 在控制台中可以访问全局对象
window.db.dataBase.data        // 查看所有剪贴板记录
window.db.dataBase.data.length // 查看记录数量
window.listener.listening      // 查看监听器状态
```

### 3. 检查数据库文件

数据库文件位置：
- Windows: `C:\Users\{用户名}\_utools_clipboard_manager_storage\database.json`
- macOS: `~/Library/Application Support/_utools_clipboard_manager_storage/database.json`
- Linux: `~/_utools_clipboard_manager_storage/database.json`

可以直接打开 JSON 文件查看数据结构。

### 4. 检查设置

在控制台中：
```javascript
utools.dbStorage.getItem('setting')  // 查看当前设置
```

### 5. 监听事件

```javascript
// 监听剪贴板变化
window.listener.on('change', (item) => {
  console.log('剪贴板变化:', item)
})

// 监听视图更新
window.listener.on('view-change', () => {
  console.log('视图需要更新')
})
```

---

## ⚠️ 常见问题

### 问题 1: 插件无法加载

**解决方案**：
- 检查 `public/plugin.json` 文件是否存在且格式正确
- 确认 uTools 已启用开发者模式
- 尝试重启 uTools

### 问题 2: 开发服务器连接失败

**解决方案**：
- 确认 `pnpm run serve` 已启动
- 检查端口 8081 是否被占用
- 查看 `public/plugin.json` 中的 `development.main` 配置

### 问题 3: 剪贴板监听不工作

**解决方案**：
- 检查设置中的"剪贴板监听程序状态"
- 如果显示"未安装"，需要手动安装监听程序（查看设置页提示）
- 插件会自动降级到轮询模式（300ms 间隔）

### 问题 4: 快捷键冲突

**解决方案**：
- `Alt + Tab` 可能与系统快捷键冲突
- 在系统设置中禁用相关快捷键
- 或使用 `Tab` 键代替

### 问题 5: 数据不显示

**解决方案**：
- 检查数据库文件是否存在
- 查看控制台是否有错误信息
- 尝试清空数据库重新开始（点击 🧭 按钮）

---

## 📝 测试记录模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
uTools 版本: [版本号]
插件版本: [版本号]

功能测试结果:
- [ ] 基础功能正常
- [ ] 任务 1: 收藏记录保护 ✅/❌
- [ ] 任务 2: 删除确认弹窗 ✅/❌
- [ ] 任务 2.1: 收藏列表删除 ✅/❌
- [ ] 任务 3: 保留标记功能 ✅/❌
- [ ] 任务 3.1: 快速删除 ✅/❌
- [ ] 任务 4: 搜索排序优化 ✅/❌
- [ ] 任务 5: 多选操作优化 ✅/❌
- [ ] 任务 6: Tab 页快捷键 ✅/❌

发现问题:
1. [问题描述]
2. [问题描述]

备注:
[其他说明]
```

---

## 🎯 快速测试脚本

创建一个测试脚本，快速验证核心功能：

```javascript
// 在 uTools 插件控制台中执行

// 1. 检查数据库
console.log('数据库记录数:', window.db.dataBase.data.length)

// 2. 检查监听器
console.log('监听器状态:', window.listener.listening)

// 3. 检查设置
const setting = utools.dbStorage.getItem('setting')
console.log('保留标记开关:', setting.database.retainEnabled)
console.log('保留时长:', setting.database.retainHours)

// 4. 测试添加记录
const testItem = {
  id: 'test_' + Date.now(),
  type: 'text',
  data: '测试内容',
  createTime: Date.now(),
  updateTime: Date.now()
}
window.db.addItem(testItem)
console.log('测试记录已添加')

// 5. 检查是否显示
console.log('最新记录:', window.db.dataBase.data[0])
```

---

## ✅ 测试完成标准

所有功能测试通过后，确认：
- [ ] 所有新增功能按预期工作
- [ ] 快捷键无冲突且响应正常
- [ ] 无控制台错误
- [ ] 数据持久化正常
- [ ] 性能无明显问题
- [ ] UI 显示正常

测试完成后，可以提交代码或打包发布。
