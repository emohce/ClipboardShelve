# 260201-cursor-clipboard-event-loop-fix.md

## 原始实现简述（基线）

剪贴板监听系统通过以下机制工作：
1. 原生监听器或轮询模式检测剪贴板变化
2. `handleClipboardChange` 处理变化，存储数据并调用 `restoreClipboard` 写回剪贴板
3. 使用 `isRestoringClipboard` 标志防止循环

## 累计修正说明

### 1. 竞态条件修复
- **问题**：`isRestoringClipboard` 标志在 `finally` 块中同步重置，但剪贴板写入可能触发异步事件
- **修复**：使用 `setTimeout` 延迟 500ms 重置标志，给系统足够时间稳定

### 2. 三重防护机制
- **新增**：`lastRestoredItemId` 记录刚恢复的项目ID
- **新增**：`lastRestoredItemHash` 记录内容哈希，避免相同内容重复处理
- **新增**：`restoreCount` 计数连续恢复次数，最大连续恢复 3 次，超过则暂停 2 秒
- **检查**：在 `handleClipboardChange` 中多重检查是否为刚恢复的项目或内容

### 3. 事件处理器优化
- **修复**：在 `registerClipEvent` 的 `change` 事件中添加循环检查
- **新增**：`isEventListenerRegistered` 标志防止重复注册事件监听器
- **优化**：减少不必要的日志输出

### 4. 日志优化
- **移除**：`listener.js` 中的冗余日志输出
- **移除**：`pbpaste` 函数中的详细日志
- **移除**：轮询模式的定期日志输出
- **保留**：关键错误和状态信息

### 5. 熔断机制
- **目的**：即使其他机制失效，也能阻止无限循环
- **实现**：连续恢复超过 3 次自动暂停 2 秒

## 影响面与风险

### 影响面
- `src/global/initPlugin.js` 的剪贴板处理逻辑
- `public/listener.js` 的日志输出
- 原生监听器和轮询模式的行为
- 性能优化（减少日志输出）

### 风险评估
- **低风险**：仅增强防护机制，不改变核心流程
- **兼容性**：完全向后兼容
- **性能**：大幅减少日志输出，提升性能

## 测试清单

### 正常流程
- 复制文本内容正常存储
- 复制图片内容正常存储
- 剪贴板写回功能正常
- 切换应用后粘贴正常

### 边界条件
- 快速连续复制不同内容
- 复制相同内容多次
- 大文本内容复制
- 空剪贴板状态

### 异常情况
- 原生监听器退出时自动降级到轮询模式
- 剪贴板写入失败时的错误处理
- 内存不足时的行为

### 循环防护验证
- 监控控制台无无限循环日志
- CPU 占用率保持正常
- 剪贴板操作响应及时
- 连续复制相同内容不超过 3 次恢复
- 事件监听器不会重复注册

## 非目标声明

本次修改不涉及：
- 修改剪贴板数据存储结构
- 改变用户界面交互
- 调整轮询间隔时间
- 修改其他模块的日志级别
