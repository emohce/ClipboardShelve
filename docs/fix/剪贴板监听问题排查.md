# 剪贴板监听问题排查指南

## 🔍 问题现象

启动插件后，无法监听到实际的复制内容，剪贴板历史记录不更新。

---

## 🎯 监听机制说明

插件使用两种方式监听剪贴板：

1. **原生监听程序**（优先）：使用平台特定的可执行文件实时监听
   - Windows: `clipboard-event-handler-win32.exe`
   - Linux: `clipboard-event-handler-linux`
   - macOS: `clipboard-event-handler-mac`

2. **轮询模式**（降级）：如果原生程序不可用，每 300ms 轮询一次剪贴板

---

## 🔧 排查步骤

### 步骤 1: 检查监听器状态

在 uTools 插件窗口中：

1. 打开开发者工具（`F12` 或 `Ctrl + Shift + I`）
2. 在控制台执行：

```javascript
// 检查监听器状态
console.log('监听器状态:', window.listener.listening)

// 检查监听器对象
console.log('监听器对象:', window.listener)
```

**预期结果**：
- `listening: true` - 监听器正在运行
- `listening: false` - 监听器未运行

### 步骤 2: 检查原生监听程序

原生监听程序需要放在数据库路径的**父目录**中。

#### 查找数据库路径

在控制台执行：

```javascript
const setting = utools.dbStorage.getItem('setting')
const nativeId = window.exports.crypto.createHash('md5').update(require('os').hostname()).digest('hex').substring(0, 8)
console.log('数据库路径:', setting.database.path[nativeId] || setting.database.path)
```

#### 检查监听程序文件

根据你的操作系统，检查以下文件是否存在：

**Windows**:
```
{数据库路径的父目录}/clipboard-event-handler-win32.exe
```

**Linux**:
```
{数据库路径的父目录}/clipboard-event-handler-linux
```

**macOS**:
```
{数据库路径的父目录}/clipboard-event-handler-mac
```

**检查方法**：

在控制台执行：

```javascript
const path = require('path')
const { existsSync } = window.exports
const setting = utools.dbStorage.getItem('setting')
const nativeId = 'your-native-id' // 从上面获取
const dbPath = setting.database.path[nativeId] || setting.database.path

const platform = process.platform
const targetMap = {
  win32: 'clipboard-event-handler-win32.exe',
  linux: 'clipboard-event-handler-linux',
  darwin: 'clipboard-event-handler-mac'
}

const target = path.resolve(
  dbPath.split('_utools_clipboard_manager_storage')[0],
  targetMap[platform]
)

console.log('监听程序路径:', target)
console.log('文件是否存在:', existsSync(target))
```

### 步骤 3: 检查设置页状态

1. 打开插件设置页面（点击 💡 按钮）
2. 查看 **"剪贴板监听程序状态"**
   - ✅ **已安装** - 原生监听程序正常
   - ⚠️ **未安装** - 需要手动安装监听程序

### 步骤 4: 手动测试轮询模式

如果原生监听程序不可用，插件应该自动降级到轮询模式。

在控制台执行：

```javascript
// 手动触发一次剪贴板检查
const item = window.exports.clipboard.readText()
console.log('当前剪贴板内容:', item)

// 检查数据库是否有更新
console.log('数据库记录数:', window.db.dataBase.data.length)
console.log('最新记录:', window.db.dataBase.data[0])
```

### 步骤 5: 监听事件

在控制台执行，实时监控剪贴板变化：

```javascript
// 监听剪贴板变化事件
window.listener.on('change', () => {
  console.log('✅ 检测到剪贴板变化!')
  console.log('最新记录:', window.db.dataBase.data[0])
})

// 监听错误事件
window.listener.on('error', (error) => {
  console.error('❌ 监听器错误:', error)
})

// 监听关闭事件
window.listener.on('close', () => {
  console.warn('⚠️ 监听器已关闭')
})
```

然后尝试复制一些内容，观察控制台输出。

---

## 🛠️ 解决方案

### 方案 1: 安装原生监听程序（推荐）

#### Windows

1. **下载监听程序**：
   - 从项目仓库或发布页面下载 `clipboard-event-handler-win32.exe`
   - 或从其他已安装的 uTools 剪贴板插件中获取

2. **放置文件**：
   - 找到数据库路径的父目录（通常是用户主目录）
   - 将 `clipboard-event-handler-win32.exe` 放在该目录

3. **验证**：
   - 重启插件
   - 检查设置页中的"剪贴板监听程序状态"

#### Linux

1. **下载监听程序**：
   ```bash
   # 从项目仓库下载 clipboard-event-handler-linux
   ```

2. **放置并设置权限**：
   ```bash
   # 将文件放到数据库路径的父目录
   chmod +x clipboard-event-handler-linux
   ```

3. **验证**：
   - 重启插件
   - 检查设置页状态

#### macOS

1. **下载监听程序**：
   - 从项目仓库下载 `clipboard-event-handler-mac`

2. **放置并设置权限**：
   ```bash
   chmod +x clipboard-event-handler-mac
   ```

3. **验证**：
   - 重启插件
   - 检查设置页状态

### 方案 2: 使用轮询模式（临时方案）

如果无法安装原生监听程序，插件会自动使用轮询模式（每 300ms 检查一次）。

**验证轮询模式是否工作**：

```javascript
// 在控制台执行，然后复制一些内容
let lastCount = window.db.dataBase.data.length
setInterval(() => {
  const currentCount = window.db.dataBase.data.length
  if (currentCount !== lastCount) {
    console.log('✅ 检测到新记录，轮询模式正常工作')
    lastCount = currentCount
  }
}, 1000)
```

**注意**：轮询模式可能不如原生监听及时，但功能正常。

### 方案 3: 手动重启监听器

在控制台执行：

```javascript
// 停止监听
window.listener.stopListening()

// 重新启动监听
const setting = utools.dbStorage.getItem('setting')
const nativeId = 'your-native-id' // 需要获取实际的 nativeId
window.listener.startListening(setting.database.path[nativeId])

// 检查状态
console.log('监听器状态:', window.listener.listening)
```

### 方案 4: 检查开发模式问题

如果在开发模式下测试（`npm run serve`），可能需要：

1. **确认插件已正确加载**：
   - 检查 uTools 插件列表中的状态
   - 确认连接到 `http://localhost:8081/`

2. **检查控制台错误**：
   - 查看是否有 JavaScript 错误
   - 查看是否有监听器启动错误

3. **重新加载插件**：
   - 在 uTools 中卸载并重新加载插件
   - 或重启 uTools

---

## 🐛 常见问题

### 问题 1: 监听程序路径不正确

**症状**：设置页显示"未安装"，但文件实际存在

**解决方案**：
1. 检查数据库路径配置
2. 确认监听程序文件在正确的父目录
3. 检查文件权限（Linux/macOS）

### 问题 2: 监听程序启动失败

**症状**：控制台显示错误，监听器状态为 `false`

**解决方案**：
1. 检查文件是否存在且可执行
2. 检查杀毒软件是否拦截
3. 尝试以管理员权限运行 uTools（Windows）

### 问题 3: 开发模式下监听不工作

**症状**：开发服务器运行正常，但监听不工作

**可能原因**：
- 开发模式下，监听器可能需要在 uTools 环境中运行
- 某些 API 在开发模式下可能受限

**解决方案**：
1. 构建生产版本测试：`npm run build`
2. 在 uTools 中加载生产版本
3. 或等待插件完全加载后再测试

### 问题 4: 轮询模式也不工作

**症状**：即使轮询模式也不检测到变化

**排查步骤**：

```javascript
// 1. 检查 pbpaste 函数
const testItem = window.exports.clipboard.readText()
console.log('剪贴板文本:', testItem)

// 2. 检查 handleClipboardChange 是否被调用
// 在 initPlugin.js 中添加 console.log

// 3. 检查数据库写入权限
try {
  window.db.updateDataBaseLocal()
  console.log('✅ 数据库写入正常')
} catch (error) {
  console.error('❌ 数据库写入失败:', error)
}
```

---

## 📋 调试检查清单

- [ ] 监听器状态为 `true`
- [ ] 原生监听程序文件存在
- [ ] 监听程序文件有执行权限（Linux/macOS）
- [ ] 设置页显示"已安装"
- [ ] 控制台无错误信息
- [ ] 事件监听器已注册
- [ ] 数据库路径正确
- [ ] 数据库文件可写
- [ ] 尝试复制内容后，数据库记录增加

---

## 🔍 详细调试脚本

在 uTools 插件控制台中执行以下完整调试脚本：

```javascript
// ===== 剪贴板监听调试脚本 =====

console.log('=== 开始调试剪贴板监听 ===\n')

// 1. 检查监听器状态
console.log('1. 监听器状态:', window.listener.listening)
console.log('   监听器对象:', window.listener)

// 2. 检查数据库路径
const setting = utools.dbStorage.getItem('setting')
const os = require('os')
const crypto = require('crypto')
const nativeId = crypto.createHash('md5').update(os.hostname()).digest('hex').substring(0, 8)
const dbPath = setting.database.path[nativeId] || setting.database.path
console.log('\n2. 数据库路径:', dbPath)

// 3. 检查监听程序文件
const path = require('path')
const { existsSync } = window.exports
const platform = process.platform
const targetMap = {
  win32: 'clipboard-event-handler-win32.exe',
  linux: 'clipboard-event-handler-linux',
  darwin: 'clipboard-event-handler-mac'
}
const target = path.resolve(
  dbPath.split('_utools_clipboard_manager_storage')[0],
  targetMap[platform]
)
console.log('\n3. 监听程序路径:', target)
console.log('   文件是否存在:', existsSync(target))

// 4. 检查数据库
console.log('\n4. 数据库记录数:', window.db.dataBase.data.length)
console.log('   最新记录:', window.db.dataBase.data[0])

// 5. 检查当前剪贴板
const clipboardText = window.exports.clipboard.readText()
console.log('\n5. 当前剪贴板文本:', clipboardText ? clipboardText.substring(0, 50) : '(空)')

// 6. 注册事件监听
console.log('\n6. 注册事件监听器...')
window.listener.on('change', () => {
  console.log('   ✅ 检测到剪贴板变化!')
  console.log('   最新记录:', window.db.dataBase.data[0])
})
window.listener.on('error', (error) => {
  console.error('   ❌ 监听器错误:', error)
})
window.listener.on('close', () => {
  console.warn('   ⚠️ 监听器已关闭')
})

console.log('\n=== 调试完成，请尝试复制一些内容 ===')
console.log('提示: 如果看到 "✅ 检测到剪贴板变化!" 说明监听正常')
```

---

## ✅ 验证监听是否正常

执行以下测试：

1. **复制一段文本**
2. **等待 1-2 秒**
3. **检查数据库**：

```javascript
// 检查是否有新记录
const newRecord = window.db.dataBase.data[0]
console.log('最新记录:', newRecord)
```

如果看到新记录，说明监听正常。

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. **收集信息**：
   - 操作系统版本
   - uTools 版本
   - 控制台完整错误信息
   - 监听器状态和路径信息

2. **检查项目文档**：
   - 查看 README.md
   - 查看项目 Issues

3. **联系开发者**：
   - GitHub Issues
   - uTools 论坛

---

## 💡 提示

- **开发模式**：在开发模式下，某些功能可能受限，建议构建生产版本测试
- **权限问题**：Linux/macOS 可能需要给监听程序添加执行权限
- **杀毒软件**：某些杀毒软件可能拦截原生监听程序
- **多实例**：确保没有多个插件实例同时运行
